<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.bus.dao.ScheduleManageDAO">

	<!-- 정규 휴무가 정해지지 않은, 노선은 배정된 기사님 뽑기 -->
	<select id="getUndecideReguloffMember" resultType="kr.or.bus.dto.MemberJoinRegulOffDTO">
		select
		mem.M_ID, mem.M_NAME, rou.R_NUM
		from member mem
		join bus bu
		on
		mem.B_VEHICLENUM = bu.B_VEHICLENUM
		join route rou
		on rou.R_NUM =
		bu.R_NUM
		where mem.M_ID not in (select m_id from reguloff) and
		rou.r_num = #{r_num}
	</select>

	<!-- 노선값 불러오기 -->
	<select id="getTotalRoute" resultType="kr.or.bus.dto.RouteJoinGarageDTO">
		select rou.r_num,
		rou.G_NUM, gar.G_NAME
		from route rou
		join garage gar
		on gar.g_num = rou.g_num
		where rou.g_num = #{g_num}
	</select>

	<!-- 차고지 값 불러오기 -->
	<select id="getTotalGarage" resultType="kr.or.bus.dto.GarageDTO">
		select g_num, g_name,
		g_x, g_y, g_addr, g_space, g_currentpark from garage
	</select>
	
	
	<!-- history -->
	<select id="history_select" resultType="kr.or.bus.dto.RegulOffrJoinDTO">
		select 
		r.ko_code,
		r.m_id,
		r.o_code,
		r.ro_code,
		r.ro_reqdate,
		r.ro_regdate,
		r.ro_object,
		
		k.ko_name,
		o.o_date as bd,
		mo.o_date as ad,
		m.m_name as bn,
		me.m_name as an
		
		from reguloffr r
		join member m on r.m_id=m.m_id
		join koff k on r.ko_code=k.ko_code
		join moff o on r.o_code=o.o_code
	    join moff mo on r.ro_code=mo.o_code
	    join member me on r.ro_object=me.m_id
	</select>
	<update id="history_agree" parameterType="map">
		update reguloffr
		set ko_code='601',
		o_check='Y',
		ro_regdate=sysdate
		where m_id=#{m_id} and ro_object=#{ro_object}
	</update>
	
	<!-- timetable -->
	<select id="selectdistinct" resultType="kr.or.bus.dto.SelectDistinctDTO">
		select distinct m.m_name, b.r_num, m.b_vehiclenum, o.o_date from member m
		join bus b on m.b_vehiclenum=b.b_vehiclenum
		join oschedule o on m.b_vehiclenum=o.b_vehiclenum
	</select>
	<select id="selecttime" resultType="String">
		select o_time from oschedule
		where o_date=#{o_date} and b_vehiclenum=#{b_vehiclenum}
	</select>
	

	<!-- 정기휴무가 정해진 노선이 배정된 기사님 뽑기 -->
	<select id="getDecideReguloffMember"
		resultType="kr.or.bus.dto.MemberJoinReguloffJoinMoffJoinBusJoinRouteJoinDTO">
		select rego.M_ID, mem.m_name, mo.O_DATE, mo.o_code
		from member mem
		join reguloff rego
		on rego.M_ID = mem.M_ID
		join moff mo
		on mo.O_CODE = rego.O_CODE
		join bus bu
		on mem.B_VEHICLENUM = bu.B_VEHICLENUM
		join route rou
		on rou.R_NUM = bu.R_NUM
		where rou.r_num = #{r_num}
	</select>
	
	<select id="getOcode" resultType="String">
		select o_code from moff where o_date = #{o_date}
	</select>
	
	<insert id="insertReguloff" parameterType="String">
		insert into reguloff(m_id, o_code, ro_regdate) values(#{param1},#{param2},sysdate)
	</insert>
	
	<update id="updateReguloff">
		update reguloff set o_code = #{param2} where m_id = #{param1}
	</update>
	
	<!-- 최종예상스케줄에 관련된 데이터 불러오기 -->

	<select id="getmemberjoinreg" resultType="kr.or.bus.dto.MemberJoinRegulOffrDTO">
		select mem.m_id, mem.m_name, reg.o_code
		from member mem join reguloff reg on mem.m_id=reg.m_id
	</select>
	
	<select id="getrnum" resultType="kr.or.bus.dto.RouteDTO">
	select r_num from route
	</select>
</mapper>