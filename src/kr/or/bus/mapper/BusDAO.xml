<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.bus.dao.BusDAO">
	<select id="busInfo" 
		resultType = "kr.or.bus.dto.BusJoinMemberJoinGarageJoinBStatusJoinStatusDTO" 
		parameterType = "int">
		
		select * 
		from(
  			select ROWNUM r , b.b_vehiclenum , nvl(b.r_num,'(미정)') as "r_num", nvl(m.m_name,'(미정)') as "m_name" , nvl(g.g_name,'(미정)') as "g_name" , s.s_name
    		from bus b left outer join member m
    		on b.b_vehiclenum = m.b_vehiclenum
    		left outer join garage g
    		on b.G_NUM = g.g_num
    		left outer join bstatus bs
    		on b.b_vehiclenum = bs.b_vehiclenum
    		left outer join status s
    		on bs.s_code = s.s_code
    		)
		where r between 1 + (#{page} - 1) * 10  and 10 + (#{page} - 1) * 10 
		order by r
	
	</select>
	
	<select id="busCount" resultType = "int">
		select count(*)
  		from bus
	</select>
	
	<select id="getGarageName" resultType = "kr.or.bus.dto.BusJoinMemberJoinGarageJoinBStatusJoinStatusDTO">
		select g_num , g_name
		from garage
	</select>
	
	<select id="getRouteNum" resultType = "kr.or.bus.dto.BusJoinMemberJoinGarageJoinBStatusJoinStatusDTO"
	 parameterType = "String">
		select r_num
		from route
		where g_num = #{g_num}
	</select>
	
	<select id="getMember" resultType = "kr.or.bus.dto.MemberDTO">
	
		select m_id , m_name
		from member
		where b_vehiclenum is null
	</select>
	
	<insert id="insertBus">
	insert into bus(b_vehiclenum 
	<if test="param2 != '선택'">
	,r_num 
	</if>
	<if test="param3 != '선택'">
	, g_num
	</if>
	, b_order) 
	values (#{param1}
	<if test="param2 != '선택'">
	,#{param2}
	</if>
	<if test="param3 != '선택'">
	,#{param3}
	</if>
	,(select max(nvl(b_order,0))+1 from bus))
	</insert>
	
	<update id="updateVehicle">
	update member
	set b_vehiclenum = #{param1}
	where m_id = #{param2}
	</update>
	
	<insert id="insertBStatus">
	insert into bstatus(b_vehiclenum , s_code 
	<if test="param2 != '선택'">
	
	,r_num 
	</if>
	,s_currenty,s_currentx,s_vacancy)
	values (#{param1} , '900' 
	<if test="param2 != '선택'">
	,#{param2}
	</if>
	,'0','0',30)
	</insert>
	
	<select id="getVehicle" resultType = "kr.or.bus.dto.BusJoinMemberJoinGarageJoinBStatusJoinStatusDTO">
		select b.b_vehiclenum , nvl(g.g_num,'(미정)') as "g_num",nvl(g.g_name,'(미정)') as "g_name", nvl(b.r_num,'(미정)') as "r_num" , nvl(m.m_name,'(미정)') as "m_name" , nvl(m.m_id,'(미정)') as "m_id"
		from bus b left outer join member m  on m.b_vehiclenum = b.b_vehiclenum
		left outer join garage g on b.g_num = g.g_num
		where b.b_vehiclenum = #{b_vehiclenum}
	</select>
	
	<select id="getGarage" resultType = "kr.or.bus.dto.BusJoinMemberJoinGarageJoinBStatusJoinStatusDTO" parameterType = "String">
		select g_num,g_name from garage where g_num != #{g_num}
	</select>
	
	<select id="getRoute" resultType = "kr.or.bus.dto.BusJoinMemberJoinGarageJoinBStatusJoinStatusDTO" parameterType = "String">
		select r_num
		from route
		where g_num = #{g_num}
	</select>
	
	
	<select id="getMembers" resultType = "kr.or.bus.dto.MemberDTO">	
		select m_id , m_name
		from member
		where b_vehiclenum is null and m_id != #{mid}
	</select>
	

	<!-- 임시 노선별 출결현황-->
	<select id="getShow"  resultType = "kr.or.bus.dto.BusJoinMemberJoinGarageJoinBStatusJoinStatusDTO">
		select mem.m_name, com.c_date, cs.cs_stat ,bus.r_num      
	    from member mem left outer join commute com on mem.m_id=com.m_id
	    left outer join bus on  bus.B_vehiclenum = mem.B_VEHICLENUM
	    left outer join cstart cs on cs.cs_code=com.cs_code
	    order by r_num
	</select>

	<select id = "alreadyUse" resultType = "int" parameterType = "String">
		select count(*)
		from bus
		where b_vehiclenum = #{b_vehiclenum}
	</select>
	
	<update id = "updateBus">
		update bus
		set b_vehiclenum = #{param1} , 
		g_num = 
		<choose>
			<when test="param2 == '선택'">
			null,
			</when>
			<when test="param2 == '(미정)'">
			null,
			</when>
			<otherwise>
			#{param2},
			</otherwise>
		</choose>
		r_num =
		<choose>
			<when test="param3 == '선택'">
			null
			</when>
			<when test="param3 == '(미정)'">
			null
			</when>
			<otherwise>
			#{param3}
			</otherwise>
		</choose>
		where b_vehiclenum = #{param4}
	</update>
	
	<update id = "updateMember">
	update member
	set b_vehiclenum = #{param1}
	where m_id = #{param2}
	</update>
	<update id = "updateVehicleNull" parameterType = "String">
	update member
	set b_vehiclenum = null
	where m_id = #{m_id}
	</update>
	<select id = "selectMemberId" resultType = "kr.or.bus.dto.MemberDTO">
	select m_id
	from member
	where b_vehiclenum = #{b_vehiclenum}
	</select>
	
	<delete id="deleteBus" parameterType = "String">
	delete
	from bus
	where b_vehiclenum = #{b_vehiclenum}
	</delete>

	
	<select id="mBus" resultType = "int">
		select count(*) 
		from busdis bd join route r 
		on bd.BD_NUM = r.BD_NUM 
		join bus b  
		on b.R_NUM = r.R_NUM 
		where bd_name = '마을버스'
	</select>
	
	<select id="nBus" resultType = "int">
		select count(*) 
		from busdis bd join route r 
		on bd.BD_NUM = r.BD_NUM 
		join bus b  
		on b.R_NUM = r.R_NUM 
		where bd_name = '시내버스'
	</select>
	
	<select id="wBus" resultType = "int">
		select count(*) 
		from busdis bd join route r 
		on bd.BD_NUM = r.BD_NUM 
		join bus b  
		on b.R_NUM = r.R_NUM 
		where bd_name = '시외버스'
	</select>
	
	<select id="gBus" resultType = "int">
		select count(*) 
		from busdis bd join route r 
		on bd.BD_NUM = r.BD_NUM 
		join bus b  
		on b.R_NUM = r.R_NUM 
		where bd_name = '고속버스'
	</select>

</mapper>